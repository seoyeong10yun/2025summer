# pip install pymupdf openai python-dotenv
import os, fitz
from openai import OpenAI
from dotenv import load_dotenv

# ============================================================
# 외부 호출을 위한 공개 서비스 함수
# ============================================================

def generate_data_summary(pdf_path: str) -> str:
    keyword_list = [
        "전국 주요관광지표",
        "소셜미디어 언급량",
        "경남 방문자 현황 1",
        "경남 방문자 현황 2",
        "방문자 거주지 분포 비율",
        "외국인 국가별 방문비율",
        "식음료, 숙박, 쇼핑몰, 백화점, 일부 교통시설을 제외한"
    ]
    extracted_pdf_path = os.getenv(
        "EXTRACTED_DATA_PDF_PATH", "data_temp.pdf"
    )

    _extract_pages_by_keywords(
        pdf_path,
        extracted_pdf_path,
        keyword_list
    )
    file_id = _upload_pdf(extracted_pdf_path)

    return _call_gpt(
        file_id,
        _data_summarize_prompt,
        model=os.getenv("GPT_MODEL_1")
    )


def generate_issue_summary(pdf_path: str) -> str:
    keyword_list = ["기사 보러가기"]
    extracted_pdf_path = os.getenv(
        "EXTRACTED_ISSUE_PDF_PATH", "issue_temp.pdf"
    )

    _extract_pages_by_keywords(
        pdf_path,
        extracted_pdf_path,
        keyword_list
    )
    file_id = _upload_pdf(extracted_pdf_path)

    return _call_gpt(
        file_id,
        _issue_summarize_prompt,
        model=os.getenv("GPT_MODEL_2")
    )


# ============================================================
# 내부 헬퍼 함수
# ============================================================

def _upload_pdf(file_path) -> str:
    with open(file_path, "rb") as pdf_file:
        response = _client.files.create(
            file=pdf_file,
            purpose="assistants"
        )
    return response.id


def _call_gpt(file_id: str, prompt: str, model: str) -> str:
    response = _client.responses.create(
        model=model,
        temperature=float(os.getenv("OPENAI_TEMPERATURE")),
        input=[
            {
                "role": "user",
                "content": [
                    {"type": "input_file", "file_id": file_id},
                    {"type": "input_text", "text": prompt}
                ]
            }
        ]
    )
    return response.output_text


def _extract_pages_by_keywords(
    input_pdf_path: str, output_pdf_path: str, keyword_list: list
) -> None:
    input_pdf = fitz.open(input_pdf_path)
    output_pdf = fitz.open()
    selected_pages = set()

    for page_num in range(len(input_pdf)):
        page = input_pdf[page_num]
        page_text = page.get_text()
        for keyword in keyword_list:
            if keyword in page_text:
                selected_pages.add(page_num)

    for page_num in sorted(selected_pages):
        output_pdf.insert_pdf(
            input_pdf, from_page=page_num, to_page=page_num
        )

    output_pdf.save(output_pdf_path)
    output_pdf.close()
    input_pdf.close()


# ============================================================
# 환경변수 로드 및 OpenAI 클라이언트 설정
# ============================================================

load_dotenv()
_client = OpenAI(
    api_key=os.getenv("OPENAI_API_KEY"),
    #base_url=os.getenv("OPENAI_API_BASE"),
    timeout=int(os.getenv("OPENAI_TIMEOUT"))
)


# ============================================================
# 프롬프트 (_data_summarize_prompt, _issue_summarize_prompt)
# ============================================================

_data_summarize_prompt = """
## 역할

- 당신은 경남 관광 데이터 현황 문서를 분석하고 요약 및 정리하여 보고서를 작성해야 하는 관광 관련 실무자입니다.
- 주어진 문서를 바탕으로 아래 조건에 맞게 재구성하여 보고서의 "경남지역 관광 데이터 요약" 단락에 들어갈 항목들을 작성해야 합니다.

---

## 지시사항

- bullet point 형식으로 작성하세요.
- 아래 "단락 구성"에 맞게 해당하는 내용을 문서에서 찾고 조합하여 각 항목을 완성하세요.
- 반드시 첨부된 문서에 나타나는 정보만을 사용하여 작성하세요.
- 답변에는 작성한 항목들을 제외한 별도 텍스트를 출력하지 마세요.
- 원문에 드러나지 않는 통계 수치나 외부 정보를 임의로 추정하여 언급하지 마세요.
- 원문에 나타나지 않는 인과관계 또는 맥락을 임의로 추론하여 추가하지 마세요.
- "단락 구성"에서 항목별로 참조해야 할 위치가 명시되어 있으니 해당 부분을 중심으로 항목을 작성하세요.
- 항목을 작성하기 위해 문서에서 참조해야 하는 부분을 찾을 수 없다면, 임의로 추론하거나 창작하지 말고 해당 항목을 작성하지 마세요.
- 되도록이면 문서에서 자연어 형태로 서술된 데이터 설명을 참고하여 재구성하세요.
- 데이터 시각화 객체(표, 차트, 기타 그림)를 바탕으로 서술해야 하는 경우, 아래 "단락 구성"에 포함된 지침을 넘어서지 않는 범위에서 해석하세요. 별도의 추론 및 다른 객체 해석을 시도하지 마세요.

---

## 단락 구성

**항목 1**
- 전년 동기 대비 전반적인 관광 지표 현황을 요약하는 텍스트
- "경남관광동향 종합분석" 챕터의 "202#년 #월 경상남도 관광추이" 하단 요약 텍스트를 그대로 포함

**항목 2**
- 경남 관광 관련 소셜미디어 언급 키워드를 설명하는 텍스트
- "경남관광동향 종합분석" 챕터의 "202#년 #월 경상남도 소셜미디어언급량"의 두 차트 하단 텍스트를 조합
- 다음 형식과 같이 서술: "소셜미디어에서 언급된 경남 관광 관련 키워드 분석 결과, 최다 ##은 **A, B, C**로, 최다 ##은 **D, E, F**로 집계됨"
- 키워드에 '기타'가 포함되는 경우, 해당 키워드를 그대로 포함하지 말고 해당 차트에서 '기타'를 포함한 키워드가 가리키는 구체적인 대상을 찾아 해당 단어로 변경

**항목 3**
- 경남 방문자 현황을 요약하는 텍스트
- "경남 방문자 현황 1/2" 챕터의 추세 설명 텍스트를 바탕으로 작성
- 다음 형식과 같이 서술: "전년 동기 대비 외부 방문자 수는 **#% 증가/감소**하였고, **A시, B시, C군**을 중심으로 방문자 집중 경향이 나타남"

**항목 4**
- 경남 방문자의 출신지를 내국인과 외국인을 구별하여 요약하는 텍스트
- 내국인의 경우 "방문자 거주지 분포 비율" 표에서 상위 3개 지역을 찾고, 각각에 해당하는 "기준월" 열의 수치(%)와 함께 나열
- 외국인의 경우 "외국인 국가별 방문비율" 표에서 상위 3개 국가를 찾고, 각각에 해당하는 '비율' 열의 수치(%)와 함께 나열
- 다음 형식과 같이 서술: "내국인의 경우 **A**(#%), **B**(#%), **C**(#%) 지역에서 온 방문자가 가장 많았고, 외국인의 경우 **X**(#%), **Y**(#%), **Z**(#%)에서 온 방문자가 가장 많았음

**항목 5**
- 가장 많이 찾은 관광지를 요약하는 텍스트
- "내비게이션 검색 인기관광지" 표의 상위 5개(1-5위) 항목을 찾아 높은 순위부터 '지역+관광지명' 나열
- 다음 형식과 같이 서술: "가장 많이 찾은 5개 관광지는 **A시 관광지1, B시 관광지2, C군 관광지3, D시 관광지4, E군 관광지5**로 조사됨"

---

## 출력 예시

<example>
- 전년 동기 대비 방문자 유입, 숙박방문자 비율, 체류시간, 목적지 검색량은 감소하였고, 관광소비는 근소한 차이로 증가함
- 소셜미디어에서 언급된 경남 관광 관련 키워드 분석 결과, 최다 여행 동반 유형은 **가족, 친구, 회사동료**로, 최다 여행 키워드는 **힐링, 나들이, 캠핑**으로 집계됨
- 전년 동기 대비 외부 방문자 수는 **0.1% 증가**하였고, **김해시, 양산시, 창원시 성산구**를 중심으로 방문자 집중 경향이 나타남
- 내국인의 경우 **부산**(40%), **대구**(10.2%), **경기**(9.3%) 지역에서 온 방문자가 가장 많았고, 외국인의 경우 **미국**(16.6%), **중국**(13.6%), **베트남**(8.9%)에서 온 방문자가 가장 많았음
- 가장 많이 찾은 5개 관광지는 **양산시 통도사, 창녕군 남지체육공원, 하동군 화개장터, 남해군 독일마을, 창원시 성산구 상남시장**으로 조사됨
</example>
"""


_issue_summarize_prompt = """
## 역할

- 당신은 경남 관광 현황을 분석 및 정리하여 보고서를 작성해야 하는 관광 관련 실무자입니다.
- 주어진 문서(경남 관광 관련 주요 10개 뉴스 요약)를 바탕으로 보고서의 "경남 주요 관광 이슈" 단락을 작성해야 합니다.
- 주어진 조건에 맞게 주요 이슈와 정책 내용을 요약해 주세요.

---

## 지시사항

- 6-7개 항목의 bullet point 형식으로 작성하세요.
- 각 항목은 1-2문장으로 간결하면서도 구체적인 정보가 간략히 드러나도록 작성하세요.
- 아래 제시된 형식과 예시를 참고하여 같은 방식으로 작성하세요.
- 전체적으로 객관적이고 중립적인 어조로 서술하세요.
- 반드시 주어진 문서만을 참고하여 작성하세요. 주어진 문서에 없는 정보를 임의로 추정하거나 창작하여 작성하지 마세요.
- 기사별로 정리된 문서 원문을 지역별 위주로 재구성해서 정리하세요.
- 원문에 드러나지 않는 통계 수치나 외부 정보를 임의로 추정하여 언급하지 마세요.
- 원문에서 명확하게 표현되지 않은 슈맥락(인과관계, 시사점 등)을 임의로 추론하여 창작하지 마세요.
- 지명, 기관명, 행사명 등의 고유명사는 원문에 등장하는 그대로 사용하세요. 임의로 명칭을 줄이는 등 변형하여 서술하지 마세요.
- 답변에는 작성한 항목들을 제외한 별도 텍스트를 출력하지 마세요.
- 10개 뉴스 중 되도록이면 장기적이고 포괄적인 정책 추진 계획보다는, 특정 지역에서의 행사, 정책, 지원 추진 등 구체적인 사안들을 우선 선택하여 6-7개 항목에 포함하세요.

---

## 형식

각 항목은 다음 내용을 간단히 포함하여 서술되어야 합니다.
1. **대상 또는 시행 주체**: 지역명(시•군), 기관명, 관광지명, "경상남도" 등
2. **주요 행사 또는 정책 및 이슈**: 시기 및 장소가 언급된 경우 반드시 포함
3. **시행 내용 또는 계획**: 어떤 행사인지 파악할 수 있도록 포함하는 체험 또는 프로그램 내용을 간략하게 2-3가지 포함하거나, 구체적인 방식을 한두 문장으로 간략하게 서술

---

## 예시

<example>
- 고성군, 8월 초까지 당항포 내 공룡테마파크에서 유아 대상 영어 체험 캠프 운영. 공룡 모양 쿠키 만들기, 공룡 체험 워크북, 공룡 전시관 영어투어 등 다양한 체험 제공
- 하동군 지리산생태과학관, 4월부터 10월까지 어린이 가족 대상으로 생태체험 및 관광프로그램 운영. 수생 생물 관찰, 민물고기 채집, 별자리 관찰 등 체험 프로그램과 1박2일 일정의 산촌 습지 체험 등 포함
- 진주시, 산림청 주관 '2025년 산촌활력특화 사업' 공모에 최종 선정. 명석면 홍지마을을 중심으로 특화 산촌관광 모델을 구축하고 다양한 체험 프로그램 및 지역 특산물 판매 등 관광 기반 조성 예정
- 남해군, 행정안전부 주관 '생활권 단위 로컬브랜딩 활성화 사업' 선정. 공영주차장 부지 일부 활용하여 캠핑카 공유 플랫폼 구축 등 추진 예정
- 한국관광공사-국립공원공단, 경남지역 해양관광 활성화를 위한 '한려해상 낭만 선셋투어' 여행상품 공동 출시. 가족 관광객 중심으로 다양한 해양 체험 프로그램을 포함하는 1박2일 또는 2박3일 상품 운영
- 해양수산부 주관 '2025 어촌체험휴양마을 고도화' 공모사업에서 경남 2곳(통향 궁항마을, 거제 산달도마을) 선정. 노후화된 숙박시설 리모델링, 야외 공동주방 설치 예정
</example>
"""